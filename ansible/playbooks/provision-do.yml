---
- name: Provision DigitalOcean App Platform application
  hosts: localhost
  connection: local
  vars_files:
    - ../vars/do-secrets.yml
  tasks:
    - name: Load app spec from file
      ansible.builtin.slurp:
        src: "{{ playbook_dir }}/../../.do/app.yaml"
      register: app_spec_file

    - name: Parse app spec YAML
      ansible.builtin.set_fact:
        app_spec: "{{ app_spec_file.content | b64decode | from_yaml }}"

    - name: Create or update App Platform application
      digitalocean.cloud.app:
        token: "{{ digitalocean_token }}"
        state: present
        spec: "{{ app_spec }}"
        timeout: 600
      register: app_result

    - name: Display app deployment details
      ansible.builtin.debug:
        var: app_result
