---
phase: 08-tech-debt-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - Cargo.toml
  - Cargo.lock
autonomous: true

must_haves:
  truths:
    - "Project builds without curve25519-dalek [patch.crates-io] in Cargo.toml"
    - "All tests pass without the dependency patch"
    - "Cargo.lock contains only released crates (no git dependencies)"
    - "OR: Patch removal failed, patch is restored, and failure is documented"
  artifacts:
    - path: "Cargo.toml"
      provides: "Project manifest without [patch.crates-io] section"
    - path: "Cargo.lock"
      provides: "Lock file with only registry crate sources"
  key_links:
    - from: "Cargo.toml"
      to: "pkarr dependency chain"
      via: "pkarr -> ed25519-dalek -> curve25519-dalek resolution"
      pattern: "No git\\+ URLs in Cargo.lock"
---

<objective>
Attempt to remove the [patch.crates-io] curve25519-dalek override from Cargo.toml. Single attempt: if it builds and tests pass, the patch is gone. If it fails, revert immediately and document the outcome.

Purpose: Satisfy requirements DEPS-01 (patch removed) and DEPS-02 (builds and tests pass without patch). Eliminate fragile git dependency before infrastructure migration.
Output: Either a clean Cargo.toml without patches and updated Cargo.lock, or documentation that the patch must remain.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-tech-debt-cleanup/08-RESEARCH.md
@.planning/phases/08-tech-debt-cleanup/08-CONTEXT.md
@.planning/phases/08-tech-debt-cleanup/08-01-SUMMARY.md
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attempt curve25519-dalek patch removal</name>
  <files>
    Cargo.toml
    Cargo.lock
  </files>
  <action>
This is a single-attempt operation per user decision. No extended investigation.

**Step 1: Baseline verification**
Run `cargo build && cargo test` to confirm the codebase is in a known-good state before making changes.

**Step 2: Back up and remove the patch**
1. Copy `Cargo.toml` to `Cargo.toml.backup` (safety net)
2. Remove these 4 lines from Cargo.toml (lines 26-29):
   ```
   # Workaround for pkarr 5.0.2 dependency issues with pre-release curve25519-dalek
   # Patch to use compatible git version that compiles
   [patch.crates-io]
   curve25519-dalek = { git = "https://github.com/dalek-cryptography/curve25519-dalek", branch = "main" }
   ```
3. Run `cargo clean` to force fresh dependency resolution (critical — stale Cargo.lock may mask issues)

**Step 3: Build attempt**
Run `cargo build`. Two outcomes:

**If build SUCCEEDS:**
1. Run `cargo test` to verify all tests pass
2. Verify Cargo.lock no longer contains git dependencies: `grep "git+" Cargo.lock` should return empty
3. Delete the backup: `rm Cargo.toml.backup`
4. Commit both Cargo.toml and Cargo.lock:
   ```
   deps: remove curve25519-dalek patch

   The [patch.crates-io] section overriding curve25519-dalek with a git
   dependency is no longer needed. The pkarr -> ed25519-dalek ->
   curve25519-dalek dependency chain now resolves correctly from
   published crates on crates.io.

   Previously, pkarr 5.0.2 depended on ed25519-dalek 3.0.0-pre.5 which
   required curve25519-dalek 5.0.0-pre.5. The patch redirected to the
   git main branch to work around compilation issues. This is no longer
   necessary.

   Requirements DEPS-01 and DEPS-02 fulfilled.
   ```

**If build FAILS:**
1. Restore immediately: `cp Cargo.toml.backup Cargo.toml`
2. Run `cargo build` to confirm restoration works
3. Delete the backup: `rm Cargo.toml.backup`
4. Do NOT commit anything — the patch stays
5. Record the build error output for the SUMMARY (what went wrong)
6. Note: This is expected and acceptable per user decision — "If build fails, revert the patch immediately and move on"

**Important:** No extended debugging, no trying alternative approaches, no version pinning experiments. Single attempt, pass or fail. This is a locked user decision.
  </action>
  <verify>
**Success path:**
- `cargo build` succeeds without [patch.crates-io] section
- `cargo test` passes all tests
- `grep "git+" Cargo.lock` returns empty (no git dependencies)
- `grep "patch.crates-io" Cargo.toml` returns empty
- Git commit exists with both Cargo.toml and Cargo.lock changes

**Failure path:**
- Cargo.toml is restored to its pre-attempt state (with patch intact)
- `cargo build && cargo test` passes (confirming clean revert)
- SUMMARY documents the failure reason
  </verify>
  <done>Either: (A) Cargo.toml has no [patch.crates-io] section, Cargo.lock has no git dependencies, all tests pass, and DEPS-01/DEPS-02 are fulfilled; OR (B) Patch removal failed, patch is restored, codebase builds and tests pass in original state, and failure is documented in SUMMARY.</done>
</task>

</tasks>

<verification>
After task completes:
1. `cargo build` succeeds
2. `cargo test` passes all tests
3. One of:
   - (Success) `grep "patch.crates-io" Cargo.toml` returns empty AND `grep "git+" Cargo.lock` returns empty
   - (Failure) Cargo.toml still has [patch.crates-io] and SUMMARY explains why
</verification>

<success_criteria>
Phase 8 success criteria (from ROADMAP.md):
1. Project builds without curve25519-dalek patch in Cargo.toml (OR documented failure)
2. All tests pass without the dependency patch (OR pass with patch retained)
3. Unused McpError enum removed from codebase (Plan 01)
4. Cargo.lock contains only released crates (OR documented that git dependency remains)

Note: Per user decision, patch removal failure is an acceptable outcome. The phase is still "complete" if the attempt was made and the result documented. DEPS-01/DEPS-02 would remain open but the phase moves forward.
</success_criteria>

<output>
After completion, create `.planning/phases/08-tech-debt-cleanup/08-02-SUMMARY.md`
</output>
