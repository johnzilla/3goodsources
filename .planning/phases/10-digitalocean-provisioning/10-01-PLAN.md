---
phase: 10-digitalocean-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .do/app.yaml
  - ansible/playbooks/provision-do.yml
  - ansible/vars/do-secrets.yml.example
  - ansible/requirements.yml
  - .gitignore
autonomous: false

user_setup:
  - service: digitalocean
    why: "App Platform hosting and API access"
    env_vars:
      - name: DIGITALOCEAN_TOKEN
        source: "DigitalOcean Control Panel -> API -> Generate New Token (read+write scope)"
    dashboard_config:
      - task: "Install DigitalOcean GitHub App on the 3goodsources repo"
        location: "During first doctl/Ansible app create, DO will prompt to authorize GitHub access. Alternatively: DigitalOcean Control Panel -> Apps -> Create App -> select GitHub as source -> authorize."
  - service: ansible
    why: "Provisioning automation"
    env_vars: []
    dashboard_config:
      - task: "Install Ansible and DO collection"
        location: "pip3 install --user azure-core==1.26.1 pydo==0.1.7 && ansible-galaxy collection install digitalocean.cloud"

must_haves:
  truths:
    - "DO app spec YAML exists at .do/app.yaml with Docker build config"
    - "Ansible playbook can provision DO app via DigitalOcean API"
    - "Environment variables configured including PKARR_SECRET_KEY as encrypted SECRET"
    - "Health check configured at /health"
    - "Auto-deploy triggers on push to main branch"
    - "No secrets committed to git"
    - "Render deployment still running as rollback target"
  artifacts:
    - path: ".do/app.yaml"
      provides: "DO App Platform app spec with Dockerfile deployment"
      contains: "dockerfile_path"
    - path: ".do/app.yaml"
      provides: "Health check configuration"
      contains: "http_path: /health"
    - path: ".do/app.yaml"
      provides: "Auto-deploy on push"
      contains: "deploy_on_push: true"
    - path: ".do/app.yaml"
      provides: "Explicit port configuration"
      contains: "http_port: 3000"
    - path: ".do/app.yaml"
      provides: "SECRET type for PKARR key"
      contains: "type: SECRET"
    - path: "ansible/playbooks/provision-do.yml"
      provides: "Ansible provisioning playbook"
      contains: "digitalocean.cloud.app"
    - path: "ansible/requirements.yml"
      provides: "Ansible collection dependencies"
      contains: "digitalocean.cloud"
    - path: "ansible/vars/do-secrets.yml.example"
      provides: "Template for vault-encrypted secrets"
      contains: "pkarr_secret_key"
  key_links:
    - from: "ansible/playbooks/provision-do.yml"
      to: ".do/app.yaml"
      via: "slurp + from_yaml to load app spec"
      pattern: "slurp.*app\\.yaml"
    - from: "ansible/playbooks/provision-do.yml"
      to: "ansible/vars/do-secrets.yml"
      via: "vars_files include"
      pattern: "vars_files.*do-secrets"
    - from: ".do/app.yaml"
      to: "Dockerfile"
      via: "dockerfile_path reference"
      pattern: "dockerfile_path: Dockerfile"
    - from: ".gitignore"
      to: "ansible/vars/do-secrets.yml"
      via: "gitignore excludes real secrets file"
      pattern: "do-secrets\\.yml"
---

<objective>
Create DO App Platform app spec and Ansible provisioning playbook for deploying 3GS alongside existing Render deployment.

Purpose: Establish infrastructure-as-code for DigitalOcean migration. The app spec defines WHAT to deploy, and Ansible automates HOW to provision it. Render stays running as rollback target throughout.

Output: `.do/app.yaml` (app spec), `ansible/` directory (playbook + vars template + requirements), updated `.gitignore`
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-digitalocean-provisioning/10-RESEARCH.md
@render.yaml
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DO app spec and Ansible provisioning files</name>
  <files>
    .do/app.yaml
    ansible/playbooks/provision-do.yml
    ansible/vars/do-secrets.yml.example
    ansible/requirements.yml
    .gitignore
  </files>
  <action>
Create the DigitalOcean App Platform app spec and Ansible provisioning infrastructure. This mirrors the existing Render deployment (render.yaml) but targets DO App Platform.

**1. Create `.do/app.yaml`** (DO App Platform app spec):
- `name: three-good-sources-api`
- `region: nyc`
- Single service named `api` with:
  - `dockerfile_path: Dockerfile` (reuse existing Dockerfile)
  - `github.repo: johnzilla/3goodsources` (from git remote)
  - `github.branch: main`
  - `github.deploy_on_push: true` (auto-deploy, req DEPLOY-04)
  - `http_port: 3000` (CRITICAL: DO defaults to 8080, our app listens on 3000)
  - `instance_count: 1`
  - `instance_size_slug: basic-xxs` (cheapest tier, matches Render starter)
  - `health_check.http_path: /health` (req DEPLOY-03)
  - `health_check.initial_delay_seconds: 10` (Rust binary starts fast but allow buffer)
  - `health_check.period_seconds: 10`
  - `health_check.timeout_seconds: 3`
  - `health_check.success_threshold: 1`
  - `health_check.failure_threshold: 9`
  - Environment variables (all `scope: RUN_TIME`):
    - `REGISTRY_PATH=/app/registry.json` (type: GENERAL)
    - `LOG_FORMAT=json` (type: GENERAL)
    - `PORT=3000` (type: GENERAL)
    - `RUST_LOG=info` (type: GENERAL)
    - `PKARR_SECRET_KEY` with `type: SECRET` and `value: "${pkarr_secret_key}"` as placeholder comment explaining Ansible injects the real value (req SEC-01, SEC-02, DEPLOY-02)
  - Do NOT put any real secret values in app.yaml. Use a placeholder like `PLACEHOLDER_SET_VIA_ANSIBLE` for PKARR_SECRET_KEY value.

**2. Create `ansible/requirements.yml`**:
```yaml
collections:
  - name: digitalocean.cloud
```

**3. Create `ansible/vars/do-secrets.yml.example`** (template, NOT real secrets):
```yaml
# Copy this file to do-secrets.yml and fill in real values
# Then encrypt with: ansible-vault encrypt ansible/vars/do-secrets.yml
#
# NEVER commit do-secrets.yml (only .example is committed)
pkarr_secret_key: "YOUR_PKARR_SECRET_KEY_HERE"
```

**4. Create `ansible/playbooks/provision-do.yml`**:
- `hosts: localhost`, `connection: local`
- `vars_files: ../vars/do-secrets.yml`
- Tasks:
  1. Load app spec from `.do/app.yaml` using `ansible.builtin.slurp` + `b64decode | from_yaml`
  2. Override PKARR_SECRET_KEY env var value in the loaded spec with `{{ pkarr_secret_key }}` from vault-encrypted vars. Use `set_fact` to build updated envs list where PKARR_SECRET_KEY gets the real value injected.
  3. Create/update app using `digitalocean.cloud.app` module with:
     - `token: "{{ lookup('env', 'DIGITALOCEAN_TOKEN') }}"` (from environment, not committed)
     - `state: present`
     - `spec:` the modified app spec with real secret injected
     - `timeout: 600` (10 min for Docker build)
  4. Display result with `debug` showing `app_result.app.default_ingress` and `app_result.app.id`

**5. Update `.gitignore`**: Append these lines:
```
# Ansible vault secrets (only .example is committed)
ansible/vars/do-secrets.yml
```

IMPORTANT constraints:
- Do NOT modify render.yaml (Render stays as rollback target, req Success Criteria 8)
- Do NOT commit any real secret values anywhere
- The PKARR_SECRET_KEY in .do/app.yaml must have a dummy placeholder value (not empty, not the real key)
- DIGITALOCEAN_TOKEN is read from environment variable, never stored in files
  </action>
  <verify>
1. Verify files exist: `ls .do/app.yaml ansible/playbooks/provision-do.yml ansible/vars/do-secrets.yml.example ansible/requirements.yml`
2. Verify app spec has correct port: `grep 'http_port: 3000' .do/app.yaml`
3. Verify health check configured: `grep 'http_path: /health' .do/app.yaml`
4. Verify auto-deploy: `grep 'deploy_on_push: true' .do/app.yaml`
5. Verify SECRET type: `grep 'type: SECRET' .do/app.yaml`
6. Verify no real secrets in app.yaml: `grep -i 'PLACEHOLDER\|SET_VIA' .do/app.yaml`
7. Verify Ansible reads app spec: `grep 'slurp' ansible/playbooks/provision-do.yml`
8. Verify Ansible uses DO module: `grep 'digitalocean.cloud.app' ansible/playbooks/provision-do.yml`
9. Verify .gitignore updated: `grep 'do-secrets.yml' .gitignore`
10. Verify render.yaml unchanged: `git diff render.yaml` shows no changes
11. Verify no secrets in any committed file: `grep -r 'PKARR_SECRET_KEY.*=.*[a-f0-9]\{32\}' . --include='*.yaml' --include='*.yml' | grep -v '.example' | grep -v 'PLACEHOLDER'` returns empty
12. All existing tests still pass: `cargo test`
  </verify>
  <done>
- .do/app.yaml exists with Dockerfile deployment, http_port 3000, health check at /health, deploy_on_push true, PKARR_SECRET_KEY as SECRET type with placeholder value
- ansible/playbooks/provision-do.yml loads app spec, injects real secret from vault, provisions via digitalocean.cloud.app module
- ansible/vars/do-secrets.yml.example provides template for vault-encrypted secrets
- ansible/requirements.yml declares digitalocean.cloud collection dependency
- .gitignore excludes ansible/vars/do-secrets.yml (real secrets file)
- render.yaml untouched (Render still running as rollback)
- No real secrets in any committed file
- All 78 existing tests pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify DO deployment is live and healthy</name>
  <what-built>
DO App Platform app spec (.do/app.yaml) and Ansible provisioning playbook (ansible/playbooks/provision-do.yml) that together deploy the 3GS API to DigitalOcean App Platform alongside the existing Render deployment.
  </what-built>
  <how-to-verify>
Prerequisites (one-time setup):
1. Generate a DO API token: DigitalOcean Control Panel -> API -> Generate New Token (read+write)
2. Export it: `export DIGITALOCEAN_TOKEN=your_token_here`
3. Install Ansible dependencies:
   ```
   pip3 install --user azure-core==1.26.1 pydo==0.1.7
   ansible-galaxy collection install digitalocean.cloud
   ```
4. Create real secrets file from template:
   ```
   cp ansible/vars/do-secrets.yml.example ansible/vars/do-secrets.yml
   ```
5. Edit `ansible/vars/do-secrets.yml` with your real PKARR_SECRET_KEY
6. Optionally encrypt: `ansible-vault encrypt ansible/vars/do-secrets.yml`

Provision the app:
```
ansible-playbook ansible/playbooks/provision-do.yml
```
(If vault-encrypted, add `--ask-vault-pass`)

Verify deployment:
1. Note the app URL from Ansible output (e.g., `https://three-good-sources-api-xxxxx.ondigitalocean.app`)
2. Check health: `curl https://{app-url}/health` -- should return 200 with JSON including pubkey
3. Check MCP endpoint: `curl -X POST https://{app-url}/mcp -H 'Content-Type: application/json' -d '{"jsonrpc":"2.0","method":"initialize","id":1,"params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"test","version":"0.1"}}}'` -- should return 200 with server capabilities
4. Verify auto-deploy is configured in DO Console -> Apps -> three-good-sources-api -> Settings -> check "Auto-Deploy" is enabled
5. Verify Render is still running: `curl https://three-good-sources-api.onrender.com/health` -- should still return 200

Note: If GitHub authorization is needed, DO Console will prompt you to install the DigitalOcean GitHub App on the johnzilla/3goodsources repo during the first provision attempt.
  </how-to-verify>
  <resume-signal>Type "approved" with the DO app URL, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Phase 10 success criteria check:
1. `.do/app.yaml` exists with Docker build config -> verify file exists with `dockerfile_path: Dockerfile`
2. Ansible playbook provisions DO app -> verify `digitalocean.cloud.app` in playbook
3. App deployed to DO at `{app-name}.ondigitalocean.app` -> human verifies via checkpoint
4. Health check at /health passes -> human verifies via curl in checkpoint
5. Environment variables configured (PORT, RUST_LOG, REGISTRY_PATH, PKARR_SECRET_KEY as SECRET) -> verify in app spec
6. Auto-deploy on push to main -> verify `deploy_on_push: true` in app spec, human confirms in DO console
7. No secrets committed to git -> grep verification + .gitignore check
8. Render still running -> human verifies via curl in checkpoint
</verification>

<success_criteria>
- .do/app.yaml defines complete DO App Platform deployment matching Render config
- Ansible playbook provisions the app with secret injection from vault
- DO app is live and responding at `*.ondigitalocean.app` (confirmed by human)
- Health check passes, MCP endpoint responds correctly
- Render deployment untouched and still serving traffic
- Zero secrets in git history
</success_criteria>

<output>
After completion, create `.planning/phases/10-digitalocean-provisioning/10-01-SUMMARY.md`
</output>
