---
phase: 09-cors-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server.rs
  - tests/integration_cors.rs
autonomous: true

must_haves:
  truths:
    - "CORS configured with specific origin allowlist (3gs.ai, api.3gs.ai) instead of permissive wildcard"
    - "MCP agents can POST to /mcp endpoint cross-origin from allowed origins"
    - "CorsLayer::permissive() no longer exists in the codebase"
    - "Browser OPTIONS preflight requests succeed with correct CORS headers"
    - "Requests from unlisted origins do NOT receive Access-Control-Allow-Origin header"
  artifacts:
    - path: "src/server.rs"
      provides: "Hardened CORS configuration with explicit origin allowlist"
      contains: "allow_origin"
    - path: "tests/integration_cors.rs"
      provides: "Integration tests validating CORS preflight, allowed origins, rejected origins"
      min_lines: 60
  key_links:
    - from: "src/server.rs"
      to: "tower_http::cors::CorsLayer"
      via: "CorsLayer::new() with allow_origin, allow_methods, allow_headers, expose_headers, max_age"
      pattern: "CorsLayer::new\\(\\)"
    - from: "tests/integration_cors.rs"
      to: "src/server.rs"
      via: "spawn_test_server() making HTTP requests with Origin header"
      pattern: "Origin.*3gs\\.ai"
---

<objective>
Replace permissive CORS with production-ready origin allowlist and add integration tests validating CORS behavior.

Purpose: Security hardening before DigitalOcean migration. CorsLayer::permissive() allows any origin, which is a security risk in production. Phase 9 is a prerequisite for Phase 11 DNS cutover.
Output: Hardened CORS in server.rs, integration tests in tests/integration_cors.rs
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-cors-hardening/09-RESEARCH.md
@src/server.rs
@tests/common/mod.rs
@tests/integration_mcp.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace CorsLayer::permissive() with explicit origin allowlist</name>
  <files>src/server.rs</files>
  <action>
In src/server.rs, replace `CorsLayer::permissive()` with an explicit CORS configuration:

1. Add required imports at the top of the file:
   - `use axum::http::{HeaderValue, Method};`
   - `use std::time::Duration;`
   - `use axum::http::HeaderName;`
   (Note: `header` is already imported from `axum::http`)

2. In `build_router()`, replace `.layer(CorsLayer::permissive())` with:

```rust
let cors = CorsLayer::new()
    .allow_origin([
        "https://3gs.ai".parse::<HeaderValue>().unwrap(),
        "https://api.3gs.ai".parse::<HeaderValue>().unwrap(),
    ])
    .allow_methods([Method::GET, Method::POST, Method::OPTIONS])
    .allow_headers([header::CONTENT_TYPE, header::AUTHORIZATION])
    .expose_headers([
        HeaderName::from_static("mcp-session-id"),
        HeaderName::from_static("x-request-id"),
    ])
    .max_age(Duration::from_secs(3600));
```

Then apply: `.layer(cors)` instead of `.layer(CorsLayer::permissive())`

Important notes:
- Use HTTPS protocol for both origins (not HTTP) - CORS origin matching is exact including protocol
- Do NOT add `allow_credentials(true)` - no auth mechanism exists yet (research open question 2)
- Do NOT add localhost origins - requirements specify only production domains (research open question 1)
- Keep `Method::OPTIONS` in allow_methods even though tower-http handles preflight automatically, for explicitness
- `expose_headers` uses HeaderName (not HeaderValue) for the expose_headers method - check tower-http 0.6 API. If the API expects HeaderValue instead, use `HeaderValue::from_static(...)`.
  </action>
  <verify>
Run `cargo build` - must compile with zero errors.
Run `cargo test` - all 72 existing tests must pass (CORS change should not break existing integration tests since they don't send Origin headers, and CorsLayer only adds headers when Origin is present).
Grep for "permissive" in src/ - must return zero results: `grep -r "permissive" src/`
  </verify>
  <done>
CorsLayer::permissive() removed from codebase. Explicit allow_origin with https://3gs.ai and https://api.3gs.ai configured. Build succeeds. All 72 existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CORS integration tests</name>
  <files>tests/integration_cors.rs</files>
  <action>
Create a new integration test file `tests/integration_cors.rs` that validates CORS behavior end-to-end using the existing test server infrastructure.

The file should:
1. Import `mod common;` to reuse `spawn_test_server()`
2. Use `reqwest::Client::new()` for HTTP requests (already a dev dependency)

Write these specific test cases:

**Test 1: `test_cors_preflight_allowed_origin`**
- Send OPTIONS to `/mcp` with headers: `Origin: https://3gs.ai`, `Access-Control-Request-Method: POST`, `Access-Control-Request-Headers: content-type`
- Assert response status is 200
- Assert `access-control-allow-origin` header equals `https://3gs.ai`
- Assert `access-control-allow-methods` header contains `POST`
- Assert `access-control-allow-headers` header value contains `content-type` (case-insensitive check)
- Assert `access-control-max-age` header equals `3600`

**Test 2: `test_cors_preflight_api_origin`**
- Send OPTIONS to `/mcp` with `Origin: https://api.3gs.ai`
- Assert `access-control-allow-origin` equals `https://api.3gs.ai`

**Test 3: `test_cors_actual_post_allowed_origin`**
- Send POST to `/mcp` with `Origin: https://3gs.ai` and a valid JSON-RPC initialize body
- Assert response status is 200
- Assert `access-control-allow-origin` header equals `https://3gs.ai`
- Assert response body contains valid JSON-RPC response

**Test 4: `test_cors_rejects_unlisted_origin`**
- Send POST to `/mcp` with `Origin: https://evil.com` and valid JSON-RPC body
- Assert `access-control-allow-origin` header is NOT present in response
- Note: The request itself still succeeds (200 OK) - CORS is enforced by browsers, not servers. The server just omits the CORS headers.

**Test 5: `test_cors_exposes_custom_headers`**
- Send OPTIONS to `/mcp` with `Origin: https://3gs.ai`
- Assert `access-control-expose-headers` contains `mcp-session-id`
- Assert `access-control-expose-headers` contains `x-request-id`

**Test 6: `test_cors_health_endpoint`**
- Send GET to `/health` with `Origin: https://3gs.ai`
- Assert `access-control-allow-origin` header equals `https://3gs.ai`
- Verifies CORS applies to all routes, not just /mcp

Use `reqwest::Method::OPTIONS` for preflight requests. Build request with `.request(reqwest::Method::OPTIONS, url)`.
  </action>
  <verify>
Run `cargo test integration_cors` - all 6 new tests must pass.
Run `cargo test` - all tests pass (new + existing, should be 78 total: 72 + 6).
  </verify>
  <done>
6 CORS integration tests pass: preflight with allowed origin, preflight with api origin, actual POST with allowed origin, rejection of unlisted origin, custom header exposure, and health endpoint CORS. Total test count increased from 72 to 78.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` compiles without errors or warnings
2. `cargo test` passes all tests (72 existing + 6 new = 78)
3. `grep -r "permissive" src/` returns no results
4. `grep "allow_origin" src/server.rs` returns the explicit origin configuration
5. Manual curl verification (informational, not blocking):
   ```
   # From project root, after `cargo run`:
   curl -s -o /dev/null -w "%{http_code}" -X OPTIONS http://localhost:3000/mcp \
     -H "Origin: https://3gs.ai" \
     -H "Access-Control-Request-Method: POST"
   # Expected: 200
   ```
</verification>

<success_criteria>
- CorsLayer::permissive() removed from codebase (grep confirms zero occurrences)
- Explicit origin allowlist configured for https://3gs.ai and https://api.3gs.ai
- All 78 tests pass (72 existing + 6 new CORS tests)
- CORS preflight requests return correct Access-Control-Allow-Origin, Allow-Methods, Allow-Headers, Max-Age, and Expose-Headers
- Unlisted origins receive no Access-Control-Allow-Origin header
</success_criteria>

<output>
After completion, create `.planning/phases/09-cors-hardening/09-01-SUMMARY.md`
</output>
