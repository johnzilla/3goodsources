---
phase: 11-dns-cutover-decommission
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "api.3gs.ai resolves to DO App Platform and returns healthy response"
    - "3gs.ai resolves to DO App Platform and returns landing page HTML"
    - "HTTPS works on both domains with Let's Encrypt certificates"
    - "Git history contains no committed secrets (DO tokens, PKARR keys)"
  artifacts: []
  key_links:
    - from: "DNS provider"
      to: "DO App Platform"
      via: "CNAME record for api.3gs.ai"
      pattern: "three-good-sources-api.*ondigitalocean.app"
    - from: "DNS provider"
      to: "DO App Platform"
      via: "CNAME/ALIAS/A record for 3gs.ai"
      pattern: "three-good-sources-api.*ondigitalocean.app"
---

<objective>
Deploy updated app spec to DO, cut over DNS, and verify the complete migration including secret safety.

Purpose: This is the final cutover. The app spec from Plan 01 must be deployed to DO, DNS records updated at the provider, SSL verified, and git history confirmed clean of secrets. After this, the entire 3GS stack runs on DigitalOcean.

Output: Live production deployment on custom domains with verified SSL and clean git history.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-dns-cutover-decommission/11-01-SUMMARY.md
@.planning/phases/11-dns-cutover-decommission/11-RESEARCH.md
@.do/app.yaml
@ansible/playbooks/provision-do.yml
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Deploy updated app spec and cut over DNS records</name>
  <action>
This task requires the user to perform three actions that Claude cannot automate:
1. Deploy the updated app spec (with domains) to DO
2. Update DNS records at their DNS provider
3. Wait for DNS propagation and SSL provisioning

Claude will first determine the DNS provider by running `whois 3gs.ai` and provide specific instructions.
  </action>
  <how-to-verify>

**Step 1: Deploy updated app spec to DigitalOcean**

Run the Ansible playbook to push the updated .do/app.yaml (now with domains section) to DO:

```bash
cd /home/john/projects/github.com/3goodsources
ansible-playbook ansible/playbooks/provision-do.yml
```

This updates the existing DO app with the new domain configuration. DO will begin attempting to provision Let's Encrypt certificates for both domains.

**Step 2: Update DNS records**

At your DNS provider, make these changes:

For `api.3gs.ai`:
- Delete the existing CNAME record (if pointing to Render)
- Create CNAME record: `api.3gs.ai` -> `three-good-sources-api-238s5.ondigitalocean.app`

For `3gs.ai` (apex domain):
- Delete the existing A records (currently pointing to GitHub Pages IPs: 185.199.108-111.153)
- If your DNS provider supports ALIAS/ANAME/CNAME flattening: Create ALIAS record `3gs.ai` -> `three-good-sources-api-238s5.ondigitalocean.app`
- If your DNS provider does NOT support ALIAS: You will need to use DigitalOcean DNS (transfer nameservers) or a provider that supports ALIAS records at apex

**Step 3: Verify DNS propagation (wait 5-15 minutes, then check)**

```bash
# Check api.3gs.ai resolves to DO
dig @8.8.8.8 api.3gs.ai CNAME +short
# Expected: three-good-sources-api-238s5.ondigitalocean.app.

# Check 3gs.ai resolves (depends on record type)
dig @8.8.8.8 3gs.ai A +short
# Expected: DigitalOcean IP (not GitHub Pages 185.199.x.x)

# Test HTTPS endpoints (may take 5-30 min for SSL cert provisioning)
curl -v https://api.3gs.ai/health
# Expected: 200 OK with {"status":"ok",...}

curl -v https://3gs.ai/
# Expected: 200 OK with landing page HTML

# Test MCP endpoint
curl -X POST https://api.3gs.ai/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0.0"}},"id":1}'
# Expected: 200 OK with JSON-RPC response
```

  </how-to-verify>
  <resume-signal>Type "deployed" when DNS is updated and endpoints are responding, or describe any issues encountered.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Verify git history is clean of secrets</name>
  <files></files>
  <action>
Scan the entire git history for any committed secrets. This satisfies requirement SEC-03.

Run these commands to search for secret patterns:

1. Search for DigitalOcean API tokens (format: dop_v1_...):
   ```bash
   git log --all --full-history -S "dop_v1_" --source --oneline
   ```

2. Search for PKARR secret key values (64-char hex strings in committed files):
   ```bash
   git log --all --full-history -S "PKARR_SECRET_KEY" -p -- '*.yml' '*.yaml' '*.json' '*.toml' '*.rs' | grep -E "^\+" | grep -v "^+++" | grep -iv "(example|env|type|SECRET|sync|key)" | head -20
   ```

3. Verify the secrets file was never committed:
   ```bash
   git log --all --full-history -- ansible/vars/do-secrets.yml
   ```

4. Check for any other token/password patterns in committed YAML/config:
   ```bash
   git log --all --full-history -p -- '*.yml' '*.yaml' | grep -iE "^\+.*(token|password|secret_key)\s*[:=]\s*['\"]?[a-zA-Z0-9]" | grep -v "^+++" | grep -v "type:" | grep -v "example" | grep -v "sync:" | head -20
   ```

If any of these commands return actual secret values (not just references/placeholders), flag them and recommend BFG Repo-Cleaner or git-filter-repo to clean history before any public push.

If all commands return empty or only show placeholder/reference patterns, SEC-03 is satisfied.
  </action>
  <verify>
All four git history search commands return no actual secret values. Only placeholder references (like `type: SECRET`, `sync: false`, example files) appear in results.
  </verify>
  <done>Git history verified clean of secrets. SEC-03 requirement satisfied. No DO API tokens, PKARR secret keys, or other credentials found in any commit.</done>
</task>

</tasks>

<verification>
1. `curl https://api.3gs.ai/health` returns 200 with `{"status":"ok",...}`
2. `curl https://3gs.ai/` returns 200 with landing page HTML
3. `curl -X POST https://api.3gs.ai/mcp ...` returns valid JSON-RPC response
4. SSL certificates issued by Let's Encrypt for both domains
5. Git history clean of secrets (SEC-03)
6. `dig @8.8.8.8 api.3gs.ai` resolves to DO infrastructure
7. `dig @8.8.8.8 3gs.ai` resolves to DO infrastructure (not GitHub Pages)
</verification>

<success_criteria>
- Both 3gs.ai and api.3gs.ai serve from DigitalOcean App Platform
- HTTPS works on both domains with Let's Encrypt certificates
- Landing page loads at https://3gs.ai
- MCP endpoint responds at https://api.3gs.ai/mcp
- Git history verified clean of all secrets
- All Phase 11 success criteria met (DNS-01, DNS-02, DNS-03, DNS-04, SEC-03)
</success_criteria>

<output>
After completion, create `.planning/phases/11-dns-cutover-decommission/11-02-SUMMARY.md`
</output>
