---
phase: 03-mcp-protocol-implementation
plan: 02
type: tdd
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/mcp/tools.rs
  - src/mcp/handler.rs
  - src/mcp/mod.rs
autonomous: true

must_haves:
  truths:
    - "tools/list returns all 4 tools with valid JSON schemas including inputSchema for each"
    - "get_sources returns matching category name, slug, description, and all 3 ranked sources with title, URL, description, rank"
    - "get_sources with no match returns MCP content result with isError: true and available categories"
    - "get_sources accepts optional threshold parameter for match sensitivity tuning"
    - "list_categories returns slug, display name, and domain tags for each category"
    - "get_provenance returns curator name, public key, registry version, and verification instructions"
    - "get_endorsements returns endorsements list (empty for v1)"
    - "Unknown tool name in tools/call returns JSON-RPC error -32601"
    - "Invalid tool params return JSON-RPC error -32602"
  artifacts:
    - path: "src/mcp/tools.rs"
      provides: "Tool parameter types with JsonSchema derives, tool definitions for tools/list, and 4 tool handler implementations"
      exports: ["get_tools_list", "handle_tool_call"]
    - path: "src/mcp/handler.rs"
      provides: "Updated handler with tools/list and tools/call dispatch wired to tools.rs"
      contains: "handle_tools_list"
    - path: "src/mcp/mod.rs"
      provides: "Updated re-exports including tools module"
  key_links:
    - from: "src/mcp/tools.rs"
      to: "src/matcher/mod.rs"
      via: "match_query called for get_sources tool"
      pattern: "match_query"
    - from: "src/mcp/tools.rs"
      to: "src/registry/types.rs"
      via: "Registry, Category, Source types for response formatting"
      pattern: "Registry"
    - from: "src/mcp/tools.rs"
      to: "schemars"
      via: "schema_for! macro for tool input schema generation"
      pattern: "schema_for"
    - from: "src/mcp/handler.rs"
      to: "src/mcp/tools.rs"
      via: "Dispatch tools/list and tools/call to tools module"
      pattern: "tools::"
---

<objective>
Implement all 4 MCP tools and tools/list method using TDD.

Purpose: This is the core business logic of Phase 3 -- the tool implementations that give agents access to curated sources, categories, provenance, and endorsements. TDD ensures all tool response contracts are met.
Output: Working tools/list and tools/call handlers that pass all success criteria tests.
</objective>

<execution_context>
@/home/john/.claude/agents/gsd-planner.md
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-protocol-implementation/03-CONTEXT.md
@.planning/phases/03-mcp-protocol-implementation/03-RESEARCH.md
@.planning/phases/03-mcp-protocol-implementation/03-01-SUMMARY.md
@src/mcp/types.rs
@src/mcp/handler.rs
@src/mcp/error.rs
@src/mcp/mod.rs
@src/registry/types.rs
@src/matcher/mod.rs
@src/matcher/scorer.rs
@src/matcher/config.rs
@src/matcher/error.rs
@registry.json
</context>

<feature>
  <name>MCP Tool Implementations (tools/list + 4 tools)</name>
  <files>src/mcp/tools.rs, src/mcp/handler.rs, src/mcp/mod.rs</files>
  <behavior>
    The MCP server exposes 4 tools via the tools/list and tools/call JSON-RPC methods. Each tool has defined input parameters and output format.

    **tools/list response:**
    Returns array of 4 tool definitions, each with name, description, and inputSchema (JSON Schema generated via schemars).

    **Tool definitions:**

    1. `get_sources` — Find curated sources for a topic
       - Input: `GetSourcesParams { query: String (required), threshold: Option<f64> }`
       - Success: Plain text response with category name, slug, description, registry version, curator pubkey, followed by all 3 sources (rank, title, URL, type, why)
       - No match: MCP content result with isError: true, message listing available categories
       - Empty/stop-words query: MCP content result with isError: true, descriptive message
       - If threshold param provided, use it instead of config default

    2. `list_categories` — List all available topic categories
       - Input: `ListCategoriesParams {}` (empty, no parameters)
       - Success: Plain text listing each category with slug, display name, and description (domain tags derived from slug)
       - Always succeeds (registry always has categories)

    3. `get_provenance` — Get curator identity and verification
       - Input: `GetProvenanceParams {}` (empty, no parameters)
       - Success: Plain text with curator name, public key (or "not yet configured"), registry version, endorsements count, and verification instructions
       - Always succeeds

    4. `get_endorsements` — Get endorsed curators list
       - Input: `GetEndorsementsParams {}` (empty, no parameters)
       - Success: Plain text listing endorsements (empty for v1, with message explaining this)
       - Always succeeds

    **Error behavior (per user decisions):**
    - No match on get_sources: Return success with isError: true in MCP content (NOT JSON-RPC error)
    - Unknown tool name in tools/call: JSON-RPC error -32601 "Method not found"
    - Invalid/missing params for tool: JSON-RPC error -32602 "Invalid params"
    - All response content in plain text -- no markdown in field values

    **Cases (full flow through handle_json, after initialize):**

    Initialize -> tools/list:
    - Response has result.tools array with 4 entries
    - Each tool has name, description (detailed with examples), inputSchema

    Initialize -> tools/call get_sources "learn rust":
    - Response has result.content[0].text containing "Rust Learning" and 3 sources
    - result.isError is false

    Initialize -> tools/call get_sources "quantum physics":
    - Response has result.content[0].text with "No matching category" and available slugs
    - result.isError is true

    Initialize -> tools/call get_sources with threshold 0.9:
    - Uses 0.9 as threshold instead of config default 0.4

    Initialize -> tools/call list_categories:
    - Response lists all 10 categories with slugs and names

    Initialize -> tools/call get_provenance:
    - Response includes curator name "John Turner" and registry version

    Initialize -> tools/call get_endorsements:
    - Response says no endorsements yet (v1)

    Initialize -> tools/call unknown_tool:
    - JSON-RPC error -32601

    Initialize -> tools/call get_sources with extra param:
    - JSON-RPC error -32602 (deny_unknown_fields on GetSourcesParams)
  </behavior>
  <implementation>
    **RED phase -- Write failing tests first:**

    Create `src/mcp/tools.rs` with:
    - Tool param structs (GetSourcesParams, ListCategoriesParams, GetProvenanceParams, GetEndorsementsParams) with #[derive(JsonSchema, Deserialize)] and #[serde(deny_unknown_fields)]
    - Stub functions that return unimplemented!()
    - Add `pub mod tools;` to mod.rs

    Write tests in `#[cfg(test)] mod tests` in handler.rs (integration-style tests through handle_json):

    Test helper: Reuse test_handler() from Plan 01. Add helper `init_handler(handler: &McpHandler)` that sends initialize request and asserts success.

    Tests:
    1. `test_tools_list_returns_four_tools` -- after init, tools/list returns 4 tools with correct names
    2. `test_tools_list_has_input_schemas` -- each tool in tools/list has inputSchema with type "object"
    3. `test_get_sources_success` -- "learn rust" returns content with "Rust Learning", 3 sources, isError: false
    4. `test_get_sources_includes_registry_metadata` -- response includes registry version and curator pubkey
    5. `test_get_sources_no_match` -- "quantum physics supercollider" returns isError: true with available categories
    6. `test_get_sources_empty_query` -- empty query returns isError: true
    7. `test_get_sources_custom_threshold` -- threshold: 0.9 makes "learn rust" fail (score < 0.9)
    8. `test_list_categories_returns_all` -- returns all 10 categories with slugs and names
    9. `test_get_provenance_returns_curator` -- returns curator name "John Turner"
    10. `test_get_endorsements_empty_v1` -- returns message about no endorsements
    11. `test_unknown_tool_returns_error` -- unknown tool name -> -32601
    12. `test_invalid_tool_params` -- get_sources with extra field -> -32602
    13. `test_get_sources_missing_query` -- get_sources with no arguments -> -32602

    **GREEN phase -- Implement to pass:**

    1. In `src/mcp/tools.rs`, define tool param structs:

       ```rust
       #[derive(Debug, Deserialize, JsonSchema)]
       #[serde(deny_unknown_fields)]
       pub struct GetSourcesParams {
           /// Natural language query describing what sources to find.
           /// Examples: "learn rust programming", "set up bitcoin node", "self-host email"
           pub query: String,
           /// Optional match threshold (0.0-1.0) for sensitivity tuning.
           /// Lower values return more results, higher values require closer matches.
           /// Default: 0.4
           #[serde(skip_serializing_if = "Option::is_none")]
           pub threshold: Option<f64>,
       }

       #[derive(Debug, Deserialize, JsonSchema)]
       #[serde(deny_unknown_fields)]
       pub struct ListCategoriesParams {}

       #[derive(Debug, Deserialize, JsonSchema)]
       #[serde(deny_unknown_fields)]
       pub struct GetProvenanceParams {}

       #[derive(Debug, Deserialize, JsonSchema)]
       #[serde(deny_unknown_fields)]
       pub struct GetEndorsementsParams {}
       ```

    2. Implement `pub fn get_tools_list() -> serde_json::Value`:
       Returns JSON array of 4 tool definitions. Each has:
       - `name`: snake_case tool name
       - `description`: Detailed description with examples (plain text, helps agents use tools correctly)
       - `inputSchema`: Generated via `schemars::schema_for!(ParamType)` converted to serde_json::Value

       Tool descriptions (detailed per user decision):
       - get_sources: "Find three curated, human-vetted sources for a topic. Searches across categories using fuzzy matching against known query patterns. Returns the matching category with name, description, and all three ranked sources including URLs and explanations. Example queries: 'learn rust programming', 'set up a bitcoin node', 'self-host email server'."
       - list_categories: "List all available topic categories in the registry. Returns each category's slug identifier, display name, and description. Use this to discover what topics have curated sources before querying. No parameters required."
       - get_provenance: "Get curator identity and verification information for this registry. Returns the curator's name, PKARR public key (when available), registry version, and instructions for cryptographic verification of source authenticity. No parameters required."
       - get_endorsements: "Get the list of endorsed curators for this registry. In v1, this returns an empty list. Future versions will support curator endorsements with trust relationships. No parameters required."

    3. Implement `pub fn handle_tool_call(name: &str, arguments: Option<Value>, registry: &Registry, match_config: &MatchConfig) -> Value`:
       Dispatch on tool name:
       - "get_sources" -> tool_get_sources(arguments, registry, match_config)
       - "list_categories" -> tool_list_categories(arguments, registry)
       - "get_provenance" -> tool_get_provenance(arguments, registry)
       - "get_endorsements" -> tool_get_endorsements(arguments, registry)
       - _ -> return JSON-RPC error indicator (caller handles -32601)

       Return Value is either a tool result or an error indicator. Use a Result<Value, ToolCallError> return type where ToolCallError has UnknownTool and InvalidParams variants, so the handler can map to appropriate JSON-RPC errors.

    4. Implement each tool function:

       **tool_get_sources:**
       - Parse arguments into GetSourcesParams (deny_unknown_fields catches extra params)
       - If parsing fails -> return InvalidParams error
       - If threshold provided, create modified MatchConfig with that threshold
       - Call matcher::match_query(query, registry, config)
       - On success: Format plain text response:
         ```
         Category: {name}
         Slug: {slug}
         Description: {description}

         Registry Version: {registry.version}
         Curator: {registry.curator.name} ({registry.curator.pubkey})

         Sources:

         1. {source.name}
            URL: {source.url}
            Type: {source.source_type}
            Why: {source.why}

         2. ...
         3. ...
         ```
       - Return via JsonRpcResponse::tool_result(id, text, false)
       - On MatchError::BelowThreshold: Format "No matching category found for query '{query}'. Closest match: {slug} (score: {score}). Available categories: {all_slugs joined}." Return with isError: true
       - On MatchError::EmptyQuery: "Query cannot be empty. Provide a natural language query describing what sources you need." Return with isError: true
       - On MatchError::QueryAllStopWords: "Query contains only common words (stop words) with no searchable content. Try more specific terms." Return with isError: true

       **tool_list_categories:**
       - Parse arguments into ListCategoriesParams (should be empty object or None)
       - If arguments is Some and non-null/non-empty-object, parse and deny_unknown_fields will catch extra params
       - Iterate registry.categories, sort by slug for deterministic output
       - Format plain text:
         ```
         Categories (10):

         - bitcoin-node-setup: Bitcoin Node Setup
           {description}
         - home-automation-private: Home Automation (Private)
           {description}
         ...
         ```
       - Return with isError: false

       **tool_get_provenance:**
       - Parse arguments into GetProvenanceParams
       - Format plain text:
         ```
         Curator: {registry.curator.name}
         Public Key: {registry.curator.pubkey or "Not yet configured"}
         Registry Version: {registry.version}
         Last Updated: {registry.updated}
         Endorsements: {registry.endorsements.len()} endorsement(s)

         Verification:
         This registry is curated by {name}. Source authenticity can be verified
         using the PKARR public key above. Each source is manually researched
         and vetted for quality. The registry is cryptographically signed to
         prevent tampering.
         ```
       - Return with isError: false

       **tool_get_endorsements:**
       - Parse arguments into GetEndorsementsParams
       - If endorsements empty (v1):
         ```
         Endorsements: 0

         This registry does not yet have any endorsements. Endorsements allow
         other curators to vouch for the quality of this registry's sources.
         This feature will be available in a future version.
         ```
       - If endorsements present (future): list them
       - Return with isError: false

    5. Wire tools into handler:
       - Update handle_tools_list in handler.rs: call tools::get_tools_list(), wrap in JsonRpcResponse::success
       - Update handle_tools_call in handler.rs: parse CallToolParams from params, call tools::handle_tool_call(), map Result to JsonRpcResponse

    6. Update src/mcp/mod.rs: add `pub mod tools;`

    **REFACTOR phase:**
    - Ensure all public functions and types have doc comments
    - Run `cargo clippy -- -D warnings` and fix any warnings
    - Verify all plain text responses have no markdown formatting
  </implementation>
</feature>

<verification>
1. `cargo test --lib mcp` -- all tests pass (both protocol tests from Plan 01 and new tool tests)
2. `cargo clippy -- -D warnings` -- no warnings
3. `cargo check` -- clean compilation
4. Specific success criteria verified:
   - tools/list returns 4 tools with schemas
   - get_sources "learn rust" returns Rust Learning with 3 sources
   - get_sources "quantum physics" returns isError: true
   - list_categories returns 10 categories
   - get_provenance returns curator info
   - get_endorsements returns empty list
   - Unknown tool returns -32601
   - Invalid params return -32602
</verification>

<success_criteria>
- tools/list returns all 4 tools with JSON Schema inputSchema
- get_sources matches queries and returns formatted category + sources in plain text
- get_sources no-match returns isError: true with available categories
- get_sources accepts optional threshold parameter
- list_categories returns all 10 category slugs with display names
- get_provenance returns curator name, pubkey, version, verification instructions
- get_endorsements returns empty endorsements message (v1)
- Unknown tool name returns -32601
- Invalid/extra tool params return -32602
- All tests pass, clippy clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-mcp-protocol-implementation/03-02-SUMMARY.md`
</output>
